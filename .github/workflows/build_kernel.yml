name: Build Tsurugi Kernel

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc flex bison libssl-dev libelf-dev binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu

    - name: Download Toolchain (Proton Clang)
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

    - name: Build Kernel
      env:
        ARCH: arm64
        SUBARCH: arm64
        CROSS_COMPILE: aarch64-linux-gnu-
        CROSS_COMPILE_ARM32: arm-linux-gnueabihf-
        CC: ${{ github.workspace }}/clang/bin/clang
        CLANG_TRIPLE: aarch64-linux-gnu-
      run: |
        CLANG_DIR="${{ github.workspace }}/clang/bin"
        chmod -R +x scripts/
        # Repair include-prefix links when they are checked out as plain files.
        for p in scripts/dtc/include-prefixes/*; do
          if [ -f "$p" ] && [ ! -L "$p" ]; then
            target="$(cat "$p")"
            rm -f "$p"
            ln -s "$target" "$p"
          fi
        done
        make O=out ARCH=arm64 op9_defconfig
        make O=out ARCH=arm64 olddefconfig
        make O=out ARCH=arm64 \
             CC="${CLANG_DIR}/clang" \
             HOSTCC=gcc \
             HOSTCXX=g++ \
             CROSS_COMPILE="${CLANG_DIR}/aarch64-linux-gnu-" \
             CROSS_COMPILE_ARM32="${CLANG_DIR}/arm-linux-gnueabi-" \
             LD="${CLANG_DIR}/ld.lld" \
             AR="${CLANG_DIR}/llvm-ar" \
             NM="${CLANG_DIR}/llvm-nm" \
             OBJCOPY="${CLANG_DIR}/llvm-objcopy" \
             OBJDUMP="${CLANG_DIR}/llvm-objdump" \
             STRIP="${CLANG_DIR}/llvm-strip" \
             -j$(nproc --all) \
             Image.gz-dtb dtbs

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tsurugi-kernel-op9
        path: |
          out/arch/arm64/boot/Image.gz-dtb
          out/arch/arm64/boot/dts/vendor/qcom/*.dtb
          out/arch/arm64/boot/dts/vendor/qcom/*.dtbo
